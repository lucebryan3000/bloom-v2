#!/usr/bin/env bash
# verbs/append_recommended_patterns.sh â€” TokenHeadroom: Append ignore patterns verb

verb_register "append_recommended_patterns" "verb::append_recommended_patterns::preview" "verb::append_recommended_patterns::apply"
_compute_ignore_candidates(){ printf "%s\n" "node_modules/" ".next/" "dist/" "build/" "out/" "_build/" "coverage/" "logs/" "_build/test/reports/" "test-results/" "public/export/" "docs/archive/" "docs/kb/"; }
verb::append_recommended_patterns::preview(){ local rel="$1" abs="$2"; local appended=""; while IFS= read -r pat; do [[ -d "$(abs_target "$pat")" ]] || continue; if [[ -f "$abs" ]] && grep -q -E "^${pat%/}/?$" "$abs"; then continue; fi; appended+="${pat}\n"; done < <(_compute_ignore_candidates); if [[ -z "$appended" ]]; then ui_info "No new patterns to append."; return 0; fi; local block="# Added by TokenHeadroom on $(date -u +%Y-%m-%dT%H:%M:%SZ)\n${appended}"; preview_step "[Apply/Ignores] ID: apply.ignores" "Append recommended ignore patterns that exist on disk and are not ignored" "Target: $rel\n${block}" "Restore backup in logs/backups." "Write access to $rel"; }
verb::append_recommended_patterns::apply(){ local rel="$1" abs="$2"; local tmp; tmp="$(mktemp)"; touch "$abs" 2>/dev/null || true; cp -f "$abs" "$tmp" 2>/dev/null || true; { echo ""; echo "# Added by TokenHeadroom on $(date -u +%Y-%m-%dT%H:%M:%SZ)"; _compute_ignore_candidates | while read -r pat; do [[ -d "$(abs_target "$pat")" ]] || continue; if grep -q -E "^${pat%/}/?$" "$abs" 2>/dev/null; then continue; fi; echo "$pat"; done; } >> "$tmp"; ui_info "Diff:"; diff -u "$abs" "$tmp" || true; if ! confirm_gate 1 0; then rm -f "$tmp"; return 0; fi; if ! double_confirm_if_critical 0; then rm -f "$tmp"; return 0; fi; local bak; bak="$(backup_file "$abs")"; if [[ "${DRY_RUN:-0}" -eq 1 ]]; then ui_warn "(dry-run) skipping write"; rm -f "$tmp"; return 0; fi; mv -f "$tmp" "$abs"; ui_result "Updated $rel (backup: $bak)"; }
