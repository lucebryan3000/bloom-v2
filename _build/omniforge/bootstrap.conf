#!/usr/bin/env bash
# =============================================================================
# Bootstrap Configuration (Active)
# =============================================================================
# This is the live bootstrap.conf used by omni.sh (OmniForge).
# All scripts read from this config - NEVER hardcode values in scripts.
# To customize: edit this file or override via environment variables.
#
# Example files are provided in ./example/ directory:
#   - bootstrap.conf.example (this file's template)
#   - .env.example (runtime environment variables)
#   - .gitignore.example (VCS exclusions)
#   - .claudeignore.example (Claude Code context optimization)
# =============================================================================

# -----------------------------------------------------------------------------
# Core Identity & Paths
# -----------------------------------------------------------------------------

APP_NAME="bloom2"
PROJECT_ROOT="."

# Installation targets (toggle which one to use)
# INSTALL_TARGET: "test" or "prod"
# - test: Installs to ./test/install-1/ (safe to delete for clean testing)
# - prod: Installs to ./app/ (production deployment)
INSTALL_TARGET="test"

# Installation directories
INSTALL_DIR_TEST="./test/install-1"
INSTALL_DIR_PROD="./app"

# Dynamically set INSTALL_DIR based on INSTALL_TARGET
if [[ "${INSTALL_TARGET}" == "prod" ]]; then
    INSTALL_DIR="${INSTALL_DIR_PROD}"
else
    INSTALL_DIR="${INSTALL_DIR_TEST}"
fi

# -----------------------------------------------------------------------------
# OmniForge Branding
# -----------------------------------------------------------------------------

OMNI_VERSION="3.0.0"
OMNI_TAGLINE="Infinite Architectures. Instant Foundation."
OMNI_LOGO="block"  # Options: block, gradient, shadow, simple, minimal

# Script locations (self-contained in _build/omniforge)
# SCRIPT_DIR and LOG_DIR are set dynamically by the bootstrap scripts
# See lib/logging.sh for log directory configuration

# Bootstrap state tracking (actual runs only - not updated in dry-run mode)
# Tracks which scripts have completed for resume capability across runs
# Format: script/name.sh=success:TIMESTAMP
# Location: PROJECT_ROOT/.bootstrap_state (git-ignored, runtime state only)
BOOTSTRAP_STATE_FILE="${PROJECT_ROOT}/.bootstrap_state"

# -----------------------------------------------------------------------------
# Runtime & Framework Versions
# -----------------------------------------------------------------------------

NODE_VERSION="20"
PNPM_VERSION="9"
NEXT_VERSION="15"
POSTGRES_VERSION="16"
PGVECTOR_IMAGE="pgvector/pgvector:pg16"

# -----------------------------------------------------------------------------
# Database Configuration
# -----------------------------------------------------------------------------

DB_NAME="bloom2_db"
DB_USER="bloom2"
DB_PASSWORD="change_me"
DB_PORT="5432"

# -----------------------------------------------------------------------------
# Environment Variable Names (for validation/templates)
# -----------------------------------------------------------------------------

ENV_ANTHROPIC_API_KEY="ANTHROPIC_API_KEY"
ENV_AUTH_SECRET="AUTH_SECRET"
ENV_DATABASE_URL="DATABASE_URL"

# -----------------------------------------------------------------------------
# Feature Flags (Enable/Disable Tech Stacks)
# -----------------------------------------------------------------------------

ENABLE_AUTHJS="true"
ENABLE_AI_SDK="true"
ENABLE_PG_BOSS="true"
ENABLE_SHADCN="true"
ENABLE_ZUSTAND="true"
ENABLE_PDF_EXPORTS="true"
ENABLE_TEST_INFRA="true"
ENABLE_CODE_QUALITY="true"

# -----------------------------------------------------------------------------
# Safety & Global Profiles
# -----------------------------------------------------------------------------

# Git safety: fail if working tree is dirty
GIT_SAFETY="true"
ALLOW_DIRTY="false"

# Stack profiles: full|minimal|api-only
STACK_PROFILE="full"

# CI / non-interactive mode
NON_INTERACTIVE="false"

# Logging format: plain|json
LOG_FORMAT="plain"

# Command timeout (seconds) - 0 or empty means no timeout
MAX_CMD_SECONDS="900"

# Resume behavior: skip|force
BOOTSTRAP_RESUME_MODE="skip"

# -----------------------------------------------------------------------------
# Package Names & Versions
# -----------------------------------------------------------------------------

# Core framework
PKG_NEXT="next@15"
PKG_REACT="react@19"
PKG_REACT_DOM="react-dom@19"
PKG_TYPESCRIPT="typescript@5"
PKG_TYPES_NODE="@types/node@20"
PKG_TYPES_REACT="@types/react@19"
PKG_TYPES_REACT_DOM="@types/react-dom@19"

# DB & ORM
PKG_DRIZZLE_ORM="drizzle-orm"
PKG_DRIZZLE_KIT="drizzle-kit"
PKG_POSTGRES_JS="postgres"
PKG_TSX="tsx"

# AI & Auth
PKG_VERCEL_AI="ai"
PKG_AI_SDK_ANTHROPIC="@ai-sdk/anthropic"
PKG_NEXT_AUTH="next-auth@beta"
PKG_BCRYPTJS="bcryptjs"
PKG_TYPES_BCRYPTJS="@types/bcryptjs"

# State & UI
PKG_ZUSTAND="zustand"
PKG_IMMER="immer"
PKG_CLSX="clsx"
PKG_TAILWIND_MERGE="tailwind-merge"
PKG_REACT_TO_PRINT="react-to-print"

# Jobs & Observability
PKG_PG_BOSS="pg-boss"
PKG_PINO="pino"
PKG_PINO_PRETTY="pino-pretty"

# Validation & Env
PKG_ZOD="zod"
PKG_T3_ENV="@t3-oss/env-nextjs"

# Export System (CRITICAL for business logic)
PKG_JSPDF="jspdf"
PKG_HTML2CANVAS="html2canvas"
PKG_EXCELJS="exceljs"
PKG_TYPES_EXCELJS="@types/exceljs"

# Markdown & Narrative Generation
PKG_MARKDOWN_IT="markdown-it"
PKG_REMARK="remark"
PKG_REMARK_HTML="remark-html"

# Testing
PKG_VITEST="vitest"
PKG_VITEJS_PLUGIN_REACT="@vitejs/plugin-react"
PKG_TESTING_LIBRARY_REACT="@testing-library/react"
PKG_TESTING_LIBRARY_JEST_DOM="@testing-library/jest-dom"
PKG_JSDOM="jsdom"
PKG_PLAYWRIGHT="@playwright/test"

# Code quality
PKG_ESLINT="eslint"
PKG_ESLINT_CONFIG_PRETTIER="eslint-config-prettier"
PKG_ESLINT_PLUGIN_JSX_A11Y="eslint-plugin-jsx-a11y"
PKG_PRETTIER="prettier"
PKG_HUSKY="husky"
PKG_LINT_STAGED="lint-staged"

# -----------------------------------------------------------------------------
# Package Profiles Per Technology
# -----------------------------------------------------------------------------

AUTH_PACKAGE_PROFILE="core"
AI_PACKAGE_PROFILE="core"
UI_PACKAGE_PROFILE="core"
TEST_PACKAGE_PROFILE="full"
CODE_QUALITY_PACKAGE_PROFILE="full"

# -----------------------------------------------------------------------------
# =============================================================================
# PHASE SYSTEM CONFIGURATION
# =============================================================================
# All phase configuration grouped together by phase (0-5)
# Format:
#   - PHASE_METADATA_X: Phase identity (number, name, description)
#   - PHASE_CONFIG_0N_NAME: Execution configuration (enabled, timeout, exec mode, prereq checks, dependencies)
#   - PHASE_PACKAGES_0N_NAME: Package list (references PKG_* variables defined above)
#   - BOOTSTRAP_PHASE_0N_NAME: Scripts to execute in this phase (one per line)
#
# Design: Numeric phase ordering (0-5) enables dynamic discovery and user extension
# To add a custom phase: Create PHASE_METADATA_N, PHASE_CONFIG_0N_NAME, PHASE_PACKAGES_0N_NAME, BOOTSTRAP_PHASE_0N_NAME
#
# Single source of truth: All package versions defined in PKG_* variables above
# Phases reference packages by name, making updates easy and consistent
# =============================================================================

# ─────────────────────────────────────────────────────────────────────────────
# PHASE 0: Project Foundation
# ─────────────────────────────────────────────────────────────────────────────
# Initialize Next.js, TypeScript, project structure
# Dependencies: git, node, pnpm
# Timeout: 5 minutes
# Packages: Core framework (Next.js 15, React 19, TypeScript 5, type definitions)

PHASE_METADATA_0="number:0|name:Project Foundation|description:Initialize Next.js, TypeScript, project structure"

PHASE_CONFIG_00_FOUNDATION="enabled:true|timeout:300|exec:sequential|prereq:strict|deps:git:https://git-scm.com,node:https://nodejs.org,pnpm:https://pnpm.io"

PHASE_PACKAGES_00_FOUNDATION="
PKG_NEXT
PKG_REACT
PKG_REACT_DOM
PKG_TYPESCRIPT
PKG_TYPES_NODE|enabled:false
PKG_TYPES_REACT|enabled:false
PKG_TYPES_REACT_DOM|enabled:false
"

BOOTSTRAP_PHASE_00_FOUNDATION="
foundation/init-nextjs.sh
foundation/init-typescript.sh
foundation/init-package-engines.sh
foundation/init-directory-structure.sh
"

# ─────────────────────────────────────────────────────────────────────────────
# PHASE 1: Infrastructure & Database
# ─────────────────────────────────────────────────────────────────────────────
# Docker, PostgreSQL, Drizzle ORM, environment setup (longest phase)
# Dependencies: docker, psql
# Timeout: 20 minutes
# Packages: Drizzle ORM, PostgreSQL client, Zod validation, environment setup

PHASE_METADATA_1="number:1|name:Infrastructure & Database|description:Docker, PostgreSQL, Drizzle, environment setup (takes longest)"

PHASE_CONFIG_01_INFRASTRUCTURE="enabled:true|timeout:1200|exec:sequential|prereq:strict|deps:docker:https://docker.com,psql:https://postgresql.org"

PHASE_PACKAGES_01_INFRASTRUCTURE="
PKG_DRIZZLE_ORM
PKG_DRIZZLE_KIT|enabled:false
PKG_POSTGRES_JS
PKG_TSX|enabled:false
PKG_ZOD
"

BOOTSTRAP_PHASE_01_INFRASTRUCTURE="
docker/dockerfile-multistage.sh
docker/docker-compose-pg.sh
docker/docker-pnpm-cache.sh
db/drizzle-setup.sh
db/drizzle-schema-base.sh
db/drizzle-migrations.sh
db/db-client-index.sh
env/env-validation.sh
env/zod-schemas-base.sh
env/rate-limiter.sh
env/server-action-template.sh
"

# ─────────────────────────────────────────────────────────────────────────────
# PHASE 2: Core Features
# ─────────────────────────────────────────────────────────────────────────────
# Authentication, AI/LLM integration, state management, background jobs, logging
# Dependencies: openssl (builtin)
# Timeout: 15 minutes
# Packages: Auth.js, Vercel AI SDK, Zustand, pg-boss, Pino logger

PHASE_METADATA_2="number:2|name:Core Features|description:Authentication, AI, state management, background jobs, logging"

PHASE_CONFIG_02_CORE="enabled:true|timeout:900|exec:sequential|prereq:warn|deps:openssl:builtin"

PHASE_PACKAGES_02_CORE="
PKG_NEXT_AUTH
PKG_BCRYPTJS
PKG_TYPES_BCRYPTJS
PKG_VERCEL_AI
PKG_AI_SDK_ANTHROPIC|enabled:false
PKG_ZUSTAND
PKG_IMMER|enabled:false
PKG_PG_BOSS
PKG_PINO
PKG_PINO_PRETTY|enabled:false
"

BOOTSTRAP_PHASE_02_CORE="
auth/authjs-setup.sh
auth/auth-routes.sh
ai/vercel-ai-setup.sh
ai/prompts-structure.sh
ai/chat-feature-scaffold.sh
state/zustand-setup.sh
state/session-state-lib.sh
jobs/pgboss-setup.sh
jobs/job-worker-template.sh
observability/pino-logger.sh
observability/pino-pretty-dev.sh
"

# ─────────────────────────────────────────────────────────────────────────────
# PHASE 3: User Interface
# ─────────────────────────────────────────────────────────────────────────────
# shadcn/ui components, printing support, component organization
# Dependencies: none (buildtime only)
# Timeout: 10 minutes
# Packages: shadcn/ui helpers (clsx, tailwind-merge), react-to-print

PHASE_METADATA_3="number:3|name:User Interface|description:shadcn/ui components, printing, component organization"

PHASE_CONFIG_03_UI="enabled:true|timeout:600|exec:sequential|prereq:warn|deps:"

PHASE_PACKAGES_03_UI="
PKG_CLSX|enabled:false
PKG_TAILWIND_MERGE|enabled:false
PKG_REACT_TO_PRINT|enabled:false
"

BOOTSTRAP_PHASE_03_UI="
ui/shadcn-init.sh
ui/react-to-print.sh
ui/components-structure.sh
"

# ─────────────────────────────────────────────────────────────────────────────
# PHASE 4: Extensions & Quality
# ─────────────────────────────────────────────────────────────────────────────
# Intelligence features, exports (PDF/Excel/Markdown), testing, code quality
# Dependencies: none
# Timeout: 30 minutes (optional packages, can skip some)
# Packages: Markdown/export libs, testing frameworks, linting/formatting tools

PHASE_METADATA_4="number:4|name:Extensions & Quality|description:Intelligence, exports, testing, code quality (pick what you need)"

PHASE_CONFIG_04_EXTENSIONS="enabled:true|timeout:1800|exec:sequential|prereq:warn|deps:"

PHASE_PACKAGES_04_EXTENSIONS="
PKG_MARKDOWN_IT|enabled:false
PKG_REMARK|enabled:false
PKG_REMARK_HTML|enabled:false
PKG_JSPDF|enabled:false
PKG_HTML2CANVAS|enabled:false
PKG_EXCELJS|enabled:false
PKG_TYPES_EXCELJS|enabled:false
PKG_VITEST|enabled:false
PKG_VITEJS_PLUGIN_REACT|enabled:false
PKG_TESTING_LIBRARY_REACT|enabled:false
PKG_TESTING_LIBRARY_JEST_DOM|enabled:false
PKG_JSDOM|enabled:false
PKG_PLAYWRIGHT|enabled:false
PKG_ESLINT|enabled:false
PKG_ESLINT_CONFIG_PRETTIER|enabled:false
PKG_ESLINT_PLUGIN_JSX_A11Y|enabled:false
PKG_PRETTIER|enabled:false
PKG_HUSKY|enabled:false
PKG_LINT_STAGED|enabled:false
"

BOOTSTRAP_PHASE_04_EXTENSIONS="
intelligence/melissa-prompts.sh
intelligence/roi-engine.sh
intelligence/confidence-engine.sh
intelligence/hitl-review-queue.sh
export/export-system.sh
export/pdf-export.sh
export/excel-export.sh
export/markdown-export.sh
export/json-export.sh
monitoring/health-endpoints.sh
monitoring/settings-ui.sh
monitoring/feature-flags.sh
testing/vitest-setup.sh
testing/playwright-setup.sh
testing/test-directory.sh
quality/eslint-prettier.sh
quality/husky-lintstaged.sh
quality/ts-strict-mode.sh
"

# ─────────────────────────────────────────────────────────────────────────────
# PHASE 5: User-Defined (Custom)
# ─────────────────────────────────────────────────────────────────────────────
# Reserved for user customizations - add your own scripts and packages here
# without modifying core phases. Just add scripts to BOOTSTRAP_PHASE_05_USER_DEFINED
# and packages to PHASE_PACKAGES_05_USER_DEFINED
# Dependencies: none
# Timeout: 10 minutes (adjust as needed)
# Packages: (user-defined)

PHASE_METADATA_5="number:5|name:User-Defined|description:Add your own scripts here without modifying core bootstrap phases"

PHASE_CONFIG_05_USER_DEFINED="enabled:false|timeout:600|exec:sequential|prereq:warn|deps:"

PHASE_PACKAGES_05_USER_DEFINED="
"

BOOTSTRAP_PHASE_05_USER_DEFINED="
"

# ─────────────────────────────────────────────────────────────────────────────
# Legacy Default Steps (kept for backward compatibility)
# ─────────────────────────────────────────────────────────────────────────────
# This is the full ordered list combining all phases 0-5
# Old code may reference BOOTSTRAP_STEPS_DEFAULT - it's now auto-generated from phases

BOOTSTRAP_STEPS_DEFAULT="
foundation/init-nextjs.sh
foundation/init-typescript.sh
foundation/init-package-engines.sh
foundation/init-directory-structure.sh
docker/dockerfile-multistage.sh
docker/docker-compose-pg.sh
docker/docker-pnpm-cache.sh
db/drizzle-setup.sh
db/drizzle-schema-base.sh
db/drizzle-migrations.sh
db/db-client-index.sh
env/env-validation.sh
env/zod-schemas-base.sh
env/rate-limiter.sh
env/server-action-template.sh
auth/authjs-setup.sh
auth/auth-routes.sh
ai/vercel-ai-setup.sh
ai/prompts-structure.sh
ai/chat-feature-scaffold.sh
state/zustand-setup.sh
state/session-state-lib.sh
jobs/pgboss-setup.sh
jobs/job-worker-template.sh
observability/pino-logger.sh
observability/pino-pretty-dev.sh
intelligence/melissa-prompts.sh
intelligence/roi-engine.sh
intelligence/confidence-engine.sh
intelligence/hitl-review-queue.sh
ui/shadcn-init.sh
ui/react-to-print.sh
ui/components-structure.sh
export/export-system.sh
export/pdf-export.sh
export/excel-export.sh
export/markdown-export.sh
export/json-export.sh
monitoring/health-endpoints.sh
monitoring/settings-ui.sh
monitoring/feature-flags.sh
testing/vitest-setup.sh
testing/playwright-setup.sh
testing/test-directory.sh
quality/eslint-prettier.sh
quality/husky-lintstaged.sh
quality/ts-strict-mode.sh
"
