#!/usr/bin/env bash
# =============================================================================
# OmniForge Bootstrap Configuration Template
# =============================================================================
# This is a TEMPLATE file. To use:
#   1. Copy this file: cp bootstrap.conf.example ../bootstrap.conf
#   2. Edit ../bootstrap.conf and customize values in SECTION 1 (QUICK START)
#   3. Generate secure passwords for DB_PASSWORD and other credentials
#   4. Run: omni --init
#
# SINGLE SOURCE OF TRUTH for all OmniForge settings
# =============================================================================

# =============================================================================
# SECTION 1: QUICK START - USER CONFIGURABLE
# =============================================================================
# These are the most commonly changed settings for new projects

# --- Project Identity ---
APP_NAME="myapp"
APP_VERSION="0.1.0"
APP_DESCRIPTION="Built with OmniForge"

# --- Installation Target ---
# Options: "test" (installs to ./test/install-1) or "prod" (installs to ./app)
INSTALL_TARGET="test"

# --- Stack Profile ---
# Options: ai_automation, fpa_dashboard, collab_editor, erp_gateway, asset_manager, custom_bos
# TODO: Use `omni --config` for interactive profile editor (coming soon)
STACK_PROFILE="asset_manager"

# --- Database Configuration ---
DB_NAME="myapp_db"
DB_USER="dbuser"
# IMPORTANT: Generate a secure password for production
DB_PASSWORD="CHANGE_ME_SECURE_PASSWORD"
DB_HOST="localhost"
DB_PORT="5432"

# --- Feature Flags ---
# Enable/disable major technology stacks (can be overridden by profile)
ENABLE_AUTHJS="true"
ENABLE_AI_SDK="true"
ENABLE_PG_BOSS="true"
ENABLE_SHADCN="true"
ENABLE_ZUSTAND="true"
ENABLE_PDF_EXPORTS="true"
ENABLE_TEST_INFRA="true"
ENABLE_CODE_QUALITY="true"


# =============================================================================
# SECTION 2: ADVANCED SETTINGS
# =============================================================================
# Occasionally changed settings for development workflow

# --- Preflight & Remediation ---
PREFLIGHT_REMEDIATE="${PREFLIGHT_REMEDIATE:-true}"
PREFLIGHT_SKIP_MISSING="${PREFLIGHT_SKIP_MISSING:-false}"
PREFLIGHT_DOWNLOAD_PACKAGES="${PREFLIGHT_DOWNLOAD_PACKAGES:-true}"

# --- Auto-Installation ---
AUTO_INSTALL_PNPM="${AUTO_INSTALL_PNPM:-true}"
AUTO_INSTALL_NODE="${AUTO_INSTALL_NODE:-true}"
AUTO_INSTALL_DOCKER="${AUTO_INSTALL_DOCKER:-true}"
AUTO_INSTALL_PSQL="${AUTO_INSTALL_PSQL:-true}"

# --- Logging Configuration ---
LOG_LEVEL="${LOG_LEVEL:-status}"          # Options: quiet, status, verbose
LOG_FORMAT="${LOG_FORMAT:-plain}"         # Options: plain, json
LOG_ROTATE_DAYS="30"
LOG_CLEANUP_DAYS="90"

# --- Docker Configuration ---
ENABLE_DOCKER="true"
DOCKER_EXEC_MODE="container"              # Options: host, container
ENABLE_REDIS="false"
DOCKER_REGISTRY="ghcr.io"
DOCKER_BUILDKIT="1"

# --- Safety & Behavior ---
GIT_SAFETY="true"
ALLOW_DIRTY="false"
NON_INTERACTIVE="false"
MAX_CMD_SECONDS="960"
BOOTSTRAP_RESUME_MODE="skip"              # Options: skip, force

# --- Backup Configuration ---
BACKUP_LOCATION="./backups"
ENABLE_AUTO_BACKUP="true"


# =============================================================================
# SECTION 3: SYSTEM CONFIGURATION
# =============================================================================
# Rarely changed - framework versions, paths, package definitions

# --- Framework & Tool Versions ---
NODE_VERSION="20.18.1"
PNPM_VERSION="9.15.0"
REQUIRED_NODE_VERSION="${REQUIRED_NODE_VERSION:-20}"
NEXT_VERSION="15"
POSTGRES_VERSION="16"
PGVECTOR_IMAGE="pgvector/pgvector:pg16"

# --- Project Structure ---
PROJECT_ROOT="."
OMNIFORGE_DIR="${SCRIPTS_DIR:-_build/omniforge}"
TOOLS_DIR="${PROJECT_ROOT}/.tools"
LOG_DIR="${OMNIFORGE_DIR}/logs"

# --- Installation Directories ---
INSTALL_DIR_TEST="./test/install-1"
INSTALL_DIR_PROD="./app"

# --- Source Directory Structure ---
SRC_DIR="src"
SRC_APP_DIR="${SRC_DIR}/app"
SRC_COMPONENTS_DIR="${SRC_DIR}/components"
SRC_LIB_DIR="${SRC_DIR}/lib"
SRC_DB_DIR="${SRC_DIR}/db"
SRC_STYLES_DIR="${SRC_DIR}/styles"
SRC_HOOKS_DIR="${SRC_DIR}/hooks"
SRC_TYPES_DIR="${SRC_DIR}/types"
SRC_STORES_DIR="${SRC_DIR}/stores"
SRC_TEST_DIR="${SRC_DIR}/test"
PUBLIC_DIR="public"
TEST_DIR="__tests__"
E2E_DIR="e2e"

# --- Project Directories List ---
PROJECT_DIRECTORIES="
${SRC_APP_DIR}
${SRC_COMPONENTS_DIR}
${SRC_LIB_DIR}
${SRC_DB_DIR}
${SRC_STYLES_DIR}
${SRC_HOOKS_DIR}
${SRC_TYPES_DIR}
${PUBLIC_DIR}
"

# --- Development Server ---
DEV_PORT="3000"
DEV_SERVER_URL="http://localhost:${DEV_PORT}"

# --- Local Tools Paths ---
NODE_LOCAL_DIR="${TOOLS_DIR}/node"
NODE_LOCAL_BIN="${NODE_LOCAL_DIR}/bin/node"
NPM_LOCAL_BIN="${NODE_LOCAL_DIR}/bin/npm"
NPX_LOCAL_BIN="${NODE_LOCAL_DIR}/bin/npx"
PNPM_LOCAL_DIR="${TOOLS_DIR}/pnpm"
PNPM_LOCAL_BIN="${PNPM_LOCAL_DIR}/bin/pnpm"
TOOLS_ACTIVATE_SCRIPT="${PROJECT_ROOT}/.toolsrc"

# --- Node.js Download Configuration ---
NODE_DOWNLOAD_BASE="https://nodejs.org/dist"
NODE_PLATFORM="linux"
NODE_ARCH="x64"

# --- OmniForge Setup Templates ---
OMNIFORGE_EXAMPLE_FILES_DIR="${OMNIFORGE_DIR}/example-files"
TEMPLATE_TOOLSRC="${OMNIFORGE_EXAMPLE_FILES_DIR}/.toolsrc.example"

# --- OmniForge Branding ---
OMNI_VERSION="3.0.0"
OMNI_TAGLINE="Infinite Architectures. Instant Foundation."
OMNI_LOGO="block"

# --- Environment Variable Names ---
ENV_ANTHROPIC_API_KEY="ANTHROPIC_API_KEY"
ENV_AUTH_SECRET="AUTH_SECRET"
ENV_DATABASE_URL="DATABASE_URL"

# --- Package Definitions (Core Framework) ---
PKG_NEXT="next@15"
PKG_REACT="react@19"
PKG_REACT_DOM="react-dom@19"
PKG_TYPESCRIPT="typescript@5"
PKG_TYPES_NODE="@types/node@20"
PKG_TYPES_REACT="@types/react@19"
PKG_TYPES_REACT_DOM="@types/react-dom@19"

# --- Package Definitions (Database & ORM) ---
PKG_DRIZZLE_ORM="drizzle-orm"
PKG_DRIZZLE_KIT="drizzle-kit"
PKG_POSTGRES_JS="postgres"
PKG_TSX="tsx"

# --- Package Definitions (AI & Auth) ---
PKG_VERCEL_AI="ai"
PKG_AI_SDK_OPENAI="@ai-sdk/openai"
PKG_AI_SDK_ANTHROPIC="@ai-sdk/anthropic"
PKG_NEXT_AUTH="next-auth@beta"
PKG_AUTH_DRIZZLE_ADAPTER="@auth/drizzle-adapter"
PKG_BCRYPTJS="bcryptjs"
PKG_TYPES_BCRYPTJS="@types/bcryptjs"

# --- Package Definitions (State & UI) ---
PKG_ZUSTAND="zustand"
PKG_IMMER="immer"
PKG_CLSX="clsx"
PKG_TAILWIND_MERGE="tailwind-merge"
PKG_CLASS_VARIANCE_AUTHORITY="class-variance-authority"
PKG_LUCIDE_REACT="lucide-react"
PKG_REACT_TO_PRINT="react-to-print"

# --- Package Definitions (Tailwind & PostCSS) ---
PKG_TAILWINDCSS="tailwindcss"
PKG_POSTCSS="postcss"
PKG_AUTOPREFIXER="autoprefixer"

# --- Package Definitions (Jobs & Observability) ---
PKG_PG_BOSS="pg-boss"
PKG_PINO="pino"
PKG_PINO_PRETTY="pino-pretty"

# --- Package Definitions (Validation & Env) ---
PKG_ZOD="zod"
PKG_T3_ENV="@t3-oss/env-nextjs"

# --- Package Definitions (Export System) ---
PKG_JSPDF="jspdf"
PKG_HTML2CANVAS="html2canvas"
PKG_EXCELJS="exceljs"
PKG_TYPES_EXCELJS="@types/exceljs"

# --- Package Definitions (Markdown & Narrative) ---
PKG_MARKDOWN_IT="markdown-it"
PKG_REMARK="remark"
PKG_REMARK_HTML="remark-html"

# --- Package Definitions (Testing) ---
PKG_VITEST="vitest"
PKG_VITEJS_PLUGIN_REACT="@vitejs/plugin-react"
PKG_TESTING_LIBRARY_REACT="@testing-library/react"
PKG_TESTING_LIBRARY_JEST_DOM="@testing-library/jest-dom"
PKG_JSDOM="jsdom"
PKG_PLAYWRIGHT="@playwright/test"

# --- Package Definitions (Code Quality) ---
PKG_ESLINT="eslint"
PKG_ESLINT_CONFIG_PRETTIER="eslint-config-prettier"
PKG_ESLINT_PLUGIN_JSX_A11Y="eslint-plugin-jsx-a11y"
PKG_TYPESCRIPT_ESLINT_PLUGIN="@typescript-eslint/eslint-plugin"
PKG_TYPESCRIPT_ESLINT_PARSER="@typescript-eslint/parser"
PKG_PRETTIER="prettier"
PKG_PRETTIER_PLUGIN_TAILWIND="prettier-plugin-tailwindcss"
PKG_HUSKY="husky"
PKG_LINT_STAGED="lint-staged"

# --- Package Profiles ---
AUTH_PACKAGE_PROFILE="core"
AI_PACKAGE_PROFILE="core"
UI_PACKAGE_PROFILE="core"
TEST_PACKAGE_PROFILE="full"
CODE_QUALITY_PACKAGE_PROFILE="full"


# =============================================================================
# SECTION 4: PHASE SYSTEM CONFIGURATION
# =============================================================================
# Advanced: Phase-based execution system (phases 0-5)
# Each phase defines: metadata, config, packages, and scripts
# To add custom phase: create PHASE_METADATA_N, PHASE_CONFIG_0N_*, etc.

# ─────────────────────────────────────────────────────────────────────────────
# PHASE 0: Project Foundation
# ─────────────────────────────────────────────────────────────────────────────
# Initialize Next.js, TypeScript, project structure
# Dependencies: git, node, pnpm
# Timeout: 5 minutes
# Packages: Core framework (Next.js 15, React 19, TypeScript 5, type definitions)

PHASE_METADATA_0="number:0|name:Project Foundation|description:Initialize Next.js, TypeScript, project structure"

PHASE_CONFIG_00_FOUNDATION="enabled:true|timeout:300|exec:sequential|prereq:strict|deps:git:https://git-scm.com,node:https://nodejs.org,pnpm:https://pnpm.io"

PHASE_PACKAGES_00_FOUNDATION="
PKG_NEXT
PKG_REACT
PKG_REACT_DOM
PKG_TYPESCRIPT
PKG_TYPES_NODE|enabled:false
PKG_TYPES_REACT|enabled:false
PKG_TYPES_REACT_DOM|enabled:false
"

BOOTSTRAP_PHASE_00_FOUNDATION="
foundation/init-nextjs.sh
foundation/init-typescript.sh
foundation/init-package-engines.sh
foundation/init-directory-structure.sh
"

# ─────────────────────────────────────────────────────────────────────────────
# PHASE 1: Infrastructure & Database
# ─────────────────────────────────────────────────────────────────────────────
# Docker, PostgreSQL, Drizzle ORM, environment setup (longest phase)
# Dependencies: docker, psql
# Timeout: 20 minutes
# Packages: Drizzle ORM, PostgreSQL client, Zod validation, environment setup

PHASE_METADATA_1="number:1|name:Infrastructure & Database|description:Docker, PostgreSQL, Drizzle, environment setup (takes longest)"

PHASE_CONFIG_01_INFRASTRUCTURE="enabled:true|timeout:1200|exec:sequential|prereq:strict|deps:docker:https://docker.com,psql:https://postgresql.org"

PHASE_PACKAGES_01_INFRASTRUCTURE="
PKG_DRIZZLE_ORM
PKG_DRIZZLE_KIT|enabled:false
PKG_POSTGRES_JS
PKG_TSX|enabled:false
PKG_ZOD
"

BOOTSTRAP_PHASE_01_INFRASTRUCTURE="
docker/dockerfile-multistage.sh
docker/docker-compose-pg.sh
docker/docker-pnpm-cache.sh
db/drizzle-setup.sh
db/drizzle-schema-base.sh
db/drizzle-migrations.sh
db/db-client-index.sh
env/env-validation.sh
env/zod-schemas-base.sh
env/rate-limiter.sh
env/server-action-template.sh
"

# ─────────────────────────────────────────────────────────────────────────────
# PHASE 2: Core Features
# ─────────────────────────────────────────────────────────────────────────────
# Authentication, AI/LLM integration, state management, background jobs, logging
# Dependencies: openssl (builtin)
# Timeout: 15 minutes
# Packages: Auth.js, Vercel AI SDK, Zustand, pg-boss, Pino logger

PHASE_METADATA_2="number:2|name:Core Features|description:Authentication, AI, state management, background jobs, logging"

PHASE_CONFIG_02_CORE="enabled:true|timeout:900|exec:sequential|prereq:warn|deps:openssl:builtin"

PHASE_PACKAGES_02_CORE="
PKG_NEXT_AUTH
PKG_BCRYPTJS
PKG_TYPES_BCRYPTJS
PKG_VERCEL_AI
PKG_AI_SDK_ANTHROPIC|enabled:false
PKG_ZUSTAND
PKG_IMMER|enabled:false
PKG_PG_BOSS
PKG_PINO
PKG_PINO_PRETTY|enabled:false
"

BOOTSTRAP_PHASE_02_CORE="
auth/authjs-setup.sh
auth/auth-routes.sh
ai/vercel-ai-setup.sh
ai/prompts-structure.sh
ai/chat-feature-scaffold.sh
state/zustand-setup.sh
state/session-state-lib.sh
jobs/pgboss-setup.sh
jobs/job-worker-template.sh
observability/pino-logger.sh
observability/pino-pretty-dev.sh
"

# ─────────────────────────────────────────────────────────────────────────────
# PHASE 3: User Interface
# ─────────────────────────────────────────────────────────────────────────────
# shadcn/ui components, printing support, component organization
# Dependencies: none (buildtime only)
# Timeout: 10 minutes
# Packages: shadcn/ui helpers (clsx, tailwind-merge), react-to-print

PHASE_METADATA_3="number:3|name:User Interface|description:shadcn/ui components, printing, component organization"

PHASE_CONFIG_03_UI="enabled:true|timeout:600|exec:sequential|prereq:warn|deps:"

PHASE_PACKAGES_03_UI="
PKG_CLSX|enabled:false
PKG_TAILWIND_MERGE|enabled:false
PKG_REACT_TO_PRINT|enabled:false
"

BOOTSTRAP_PHASE_03_UI="
ui/shadcn-init.sh
ui/react-to-print.sh
ui/components-structure.sh
"

# ─────────────────────────────────────────────────────────────────────────────
# PHASE 4: Extensions & Quality
# ─────────────────────────────────────────────────────────────────────────────
# Intelligence features, exports (PDF/Excel/Markdown), testing, code quality
# Dependencies: none
# Timeout: 30 minutes (optional packages, can skip some)
# Packages: Markdown/export libs, testing frameworks, linting/formatting tools

PHASE_METADATA_4="number:4|name:Extensions & Quality|description:Intelligence, exports, testing, code quality (pick what you need)"

PHASE_CONFIG_04_EXTENSIONS="enabled:true|timeout:1800|exec:sequential|prereq:warn|deps:"

PHASE_PACKAGES_04_EXTENSIONS="
PKG_MARKDOWN_IT|enabled:false
PKG_REMARK|enabled:false
PKG_REMARK_HTML|enabled:false
PKG_JSPDF|enabled:false
PKG_HTML2CANVAS|enabled:false
PKG_EXCELJS|enabled:false
PKG_TYPES_EXCELJS|enabled:false
PKG_VITEST|enabled:false
PKG_VITEJS_PLUGIN_REACT|enabled:false
PKG_TESTING_LIBRARY_REACT|enabled:false
PKG_TESTING_LIBRARY_JEST_DOM|enabled:false
PKG_JSDOM|enabled:false
PKG_PLAYWRIGHT|enabled:false
PKG_ESLINT|enabled:false
PKG_ESLINT_CONFIG_PRETTIER|enabled:false
PKG_ESLINT_PLUGIN_JSX_A11Y|enabled:false
PKG_PRETTIER|enabled:false
PKG_HUSKY|enabled:false
PKG_LINT_STAGED|enabled:false
"

BOOTSTRAP_PHASE_04_EXTENSIONS="
intelligence/melissa-prompts.sh
intelligence/roi-engine.sh
intelligence/confidence-engine.sh
intelligence/hitl-review-queue.sh
export/export-system.sh
export/pdf-export.sh
export/excel-export.sh
export/markdown-export.sh
export/json-export.sh
monitoring/health-endpoints.sh
monitoring/settings-ui.sh
monitoring/feature-flags.sh
testing/vitest-setup.sh
testing/playwright-setup.sh
testing/test-directory.sh
quality/eslint-prettier.sh
quality/husky-lintstaged.sh
quality/ts-strict-mode.sh
quality/verify-build.sh
"

# ─────────────────────────────────────────────────────────────────────────────
# PHASE 5: User-Defined (Custom)
# ─────────────────────────────────────────────────────────────────────────────
# Reserved for user customizations - add your own scripts here without modifying
# core phases. Just add scripts to BOOTSTRAP_PHASE_05_USER_DEFINED and packages
# to PHASE_PACKAGES_05_USER_DEFINED
# Dependencies: none
# Timeout: 10 minutes (adjust as needed)
# Packages: (user-defined)

PHASE_METADATA_5="number:5|name:User-Defined|description:Add your own scripts here without modifying core bootstrap phases"

PHASE_CONFIG_05_USER_DEFINED="enabled:false|timeout:600|exec:sequential|prereq:warn|deps:"

PHASE_PACKAGES_05_USER_DEFINED="
"

BOOTSTRAP_PHASE_05_USER_DEFINED="
"

# ─────────────────────────────────────────────────────────────────────────────
# Legacy Default Steps (kept for backward compatibility)
# ─────────────────────────────────────────────────────────────────────────────
# This is the full ordered list combining all phases 0-5
# Old code may reference BOOTSTRAP_STEPS_DEFAULT - it's now auto-generated from phases

BOOTSTRAP_STEPS_DEFAULT="
foundation/init-nextjs.sh
foundation/init-typescript.sh
foundation/init-package-engines.sh
foundation/init-directory-structure.sh
docker/dockerfile-multistage.sh
docker/docker-compose-pg.sh
docker/docker-pnpm-cache.sh
db/drizzle-setup.sh
db/drizzle-schema-base.sh
db/drizzle-migrations.sh
db/db-client-index.sh
env/env-validation.sh
env/zod-schemas-base.sh
env/rate-limiter.sh
env/server-action-template.sh
auth/authjs-setup.sh
auth/auth-routes.sh
ai/vercel-ai-setup.sh
ai/prompts-structure.sh
ai/chat-feature-scaffold.sh
state/zustand-setup.sh
state/session-state-lib.sh
jobs/pgboss-setup.sh
jobs/job-worker-template.sh
observability/pino-logger.sh
observability/pino-pretty-dev.sh
intelligence/melissa-prompts.sh
intelligence/roi-engine.sh
intelligence/confidence-engine.sh
intelligence/hitl-review-queue.sh
ui/shadcn-init.sh
ui/react-to-print.sh
ui/components-structure.sh
export/export-system.sh
export/pdf-export.sh
export/excel-export.sh
export/markdown-export.sh
export/json-export.sh
monitoring/health-endpoints.sh
monitoring/settings-ui.sh
monitoring/feature-flags.sh
testing/vitest-setup.sh
testing/playwright-setup.sh
testing/test-directory.sh
quality/eslint-prettier.sh
quality/husky-lintstaged.sh
quality/ts-strict-mode.sh
quality/verify-build.sh
"


# =============================================================================
# SECTION 5: STACK PROFILES
# =============================================================================
# DO NOT EDIT MANUALLY - Use `omni --config` to configure profiles
# TODO: Profile editor in omni.sh (coming soon)
#
# Available profiles:
#   - ai_automation: Document Processing & Workflows
#   - fpa_dashboard: Financial Planning & Analysis
#   - collab_editor: Real-Time Document Control
#   - erp_gateway: BOS-ERP Data Sync API
#   - asset_manager: Excel Replacement / Core CRUD (recommended)
#   - custom_bos: Modular Builder (minimal defaults)

# Profile 1: AI_AUTOMATION - Document Processing & Workflows
declare -A PROFILE_AI_AUTOMATION=(
    [name]="AI_AUTOMATION"
    [tagline]="Intelligent Process Automation"
    [description]="BOS portal for document processing, RAG, and background AI workflows"
    [time_estimate]="~80 minutes"
    [recommended]="false"
    [ENABLE_NEXTJS]="true"
    [ENABLE_DATABASE]="true"
    [ENABLE_AUTHJS]="true"
    [ENABLE_AI_SDK]="true"
    [ENABLE_PG_BOSS]="true"
    [ENABLE_SHADCN]="true"
    [ENABLE_ZUSTAND]="false"
    [ENABLE_PDF_EXPORTS]="false"
    [ENABLE_TEST_INFRA]="true"
    [ENABLE_CODE_QUALITY]="true"
)

# Profile 2: FPA_DASHBOARD - Enterprise Financial Planning & Analysis
declare -A PROFILE_FPA_DASHBOARD=(
    [name]="FPA_DASHBOARD"
    [tagline]="High-Integrity Financial Reporting"
    [description]="Secure FP&A dashboard with RBAC, charting, and PDF/Excel reporting"
    [time_estimate]="~70 minutes"
    [recommended]="false"
    [ENABLE_NEXTJS]="true"
    [ENABLE_DATABASE]="true"
    [ENABLE_AUTHJS]="true"
    [ENABLE_AI_SDK]="false"
    [ENABLE_PG_BOSS]="false"
    [ENABLE_SHADCN]="true"
    [ENABLE_ZUSTAND]="true"
    [ENABLE_PDF_EXPORTS]="true"
    [ENABLE_TEST_INFRA]="true"
    [ENABLE_CODE_QUALITY]="true"
)

# Profile 3: COLLAB_EDITOR - Real-Time Policy & Doc Editor
declare -A PROFILE_COLLAB_EDITOR=(
    [name]="COLLAB_EDITOR"
    [tagline]="Real-Time Document Control"
    [description]="Foundation for real-time apps (WebSockets/CRDT), complex state, async saving"
    [time_estimate]="~75 minutes"
    [recommended]="false"
    [ENABLE_NEXTJS]="true"
    [ENABLE_DATABASE]="true"
    [ENABLE_AUTHJS]="true"
    [ENABLE_AI_SDK]="false"
    [ENABLE_PG_BOSS]="true"
    [ENABLE_SHADCN]="true"
    [ENABLE_ZUSTAND]="true"
    [ENABLE_PDF_EXPORTS]="false"
    [ENABLE_TEST_INFRA]="true"
    [ENABLE_CODE_QUALITY]="true"
)

# Profile 4: ERP_GATEWAY - BOS-ERP Data Synchronization API
declare -A PROFILE_ERP_GATEWAY=(
    [name]="ERP_GATEWAY"
    [tagline]="Secure Data Synchronization Layer"
    [description]="API-only profile for high-volume data sync with ERP (ETL/service auth)"
    [time_estimate]="~60 minutes"
    [recommended]="false"
    [ENABLE_NEXTJS]="true"
    [ENABLE_DATABASE]="true"
    [ENABLE_AUTHJS]="true"
    [ENABLE_AI_SDK]="false"
    [ENABLE_PG_BOSS]="true"
    [ENABLE_SHADCN]="false"
    [ENABLE_ZUSTAND]="false"
    [ENABLE_PDF_EXPORTS]="false"
    [ENABLE_TEST_INFRA]="true"
    [ENABLE_CODE_QUALITY]="true"
)

# Profile 5: ASSET_MANAGER - Custom Internal Asset Management Tool
declare -A PROFILE_ASSET_MANAGER=(
    [name]="ASSET_MANAGER"
    [tagline]="Excel Replacement / Core CRUD"
    [description]="Core CRUD template replacing spreadsheets (high UI, heavy DB, reporting)"
    [time_estimate]="~65 minutes"
    [recommended]="true"
    [ENABLE_NEXTJS]="true"
    [ENABLE_DATABASE]="true"
    [ENABLE_AUTHJS]="true"
    [ENABLE_AI_SDK]="false"
    [ENABLE_PG_BOSS]="true"
    [ENABLE_SHADCN]="true"
    [ENABLE_ZUSTAND]="true"
    [ENABLE_PDF_EXPORTS]="true"
    [ENABLE_TEST_INFRA]="true"
    [ENABLE_CODE_QUALITY]="true"
)

# Profile 6: CUSTOM_BOS - Modular Builder
declare -A PROFILE_CUSTOM_BOS=(
    [name]="CUSTOM_BOS"
    [tagline]="Modular BOS Builder"
    [description]="Clean slate to select features individually (minimal defaults)"
    [time_estimate]="~45 minutes"
    [recommended]="false"
    [ENABLE_NEXTJS]="true"
    [ENABLE_DATABASE]="true"
    [ENABLE_AUTHJS]="false"
    [ENABLE_AI_SDK]="false"
    [ENABLE_PG_BOSS]="false"
    [ENABLE_SHADCN]="false"
    [ENABLE_ZUSTAND]="false"
    [ENABLE_PDF_EXPORTS]="false"
    [ENABLE_TEST_INFRA]="false"
    [ENABLE_CODE_QUALITY]="false"
)

# Available profiles (order matters - shown in this order in menu)
AVAILABLE_PROFILES=("ai_automation" "fpa_dashboard" "collab_editor" "erp_gateway" "asset_manager" "custom_bos")

# Function to apply profile changes (call after sourcing bootstrap.conf)
apply_stack_profile() {
    local profile="${1:-${STACK_PROFILE}}"
    # Convert hyphens to underscores and uppercase (api-only -> API_ONLY)
    local profile_var="PROFILE_${profile^^}"
    profile_var="${profile_var//-/_}"

    # Check if profile exists using eval (Bash 5.3 compatible)
    if ! eval "[[ \${#${profile_var}[@]} -gt 0 ]]" 2>/dev/null; then
        log_error "Unknown STACK_PROFILE: ${profile}. Available: ${AVAILABLE_PROFILES[*]}"
        return 1
    fi

    # Apply profile settings using eval (Bash 5.3 compatible)
    local keys
    keys=$(eval "echo \${!${profile_var}[@]}")
    for key in $keys; do
        # Skip metadata fields, only apply feature flags
        if [[ "$key" =~ ^ENABLE_ ]]; then
            local value
            value=$(eval "echo \${${profile_var}[$key]}")
            export "${key}=${value}"
        fi
    done

    log_debug "Applied profile: ${profile}"
    return 0
}

# Function to get profile by number (for menu display)
get_profile_by_number() {
    local num=$1
    local idx=$((num - 1))  # Convert to 0-based index

    if [[ $idx -lt 0 ]] || [[ $idx -ge ${#AVAILABLE_PROFILES[@]} ]]; then
        echo ""
        return 1
    fi

    echo "${AVAILABLE_PROFILES[$idx]}"
}

# Function to get profile metadata
get_profile_metadata() {
    local profile="$1"
    local key="$2"
    # Convert hyphens to underscores and uppercase (api-only -> API_ONLY)
    local profile_var="PROFILE_${profile^^}"
    profile_var="${profile_var//-/_}"

    # Check if profile array exists using eval (Bash 5.3 compatible)
    if ! eval "[[ \${#${profile_var}[@]} -gt 0 ]]" 2>/dev/null; then
        return 1
    fi

    # Get value using eval (Bash 5.3 compatible)
    eval "echo \${${profile_var}[$key]:-}"
}


# =============================================================================
# SECTION 6: AUTO-DETECTED / INTERNAL (DO NOT TOUCH)
# =============================================================================
# These values are set at runtime or computed from other settings
# DO NOT EDIT - They will be overwritten

# --- Dynamically Computed Installation Directory ---
if [[ "${INSTALL_TARGET}" == "prod" ]]; then
    INSTALL_DIR="${INSTALL_DIR_PROD}"
else
    INSTALL_DIR="${INSTALL_DIR_TEST}"
fi

# --- Runtime State Markers ---
OMNIFORGE_CONFIG_INITIALIZED="${OMNIFORGE_CONFIG_INITIALIZED:-false}"
OMNIFORGE_SETUP_MARKER="${PROJECT_ROOT}/.omniforge_setup_complete"
BOOTSTRAP_STATE_FILE="${PROJECT_ROOT}/.bootstrap_state"

# --- Auto-Detected Git Information ---
GIT_REMOTE_URL="${GIT_REMOTE_URL:-}"

# =============================================================================
# END OF CONFIGURATION
# =============================================================================
