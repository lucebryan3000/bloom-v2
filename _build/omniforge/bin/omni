#!/usr/bin/env bash
# =============================================================================
# bin/omni - OmniForge Main Entry Point
# =============================================================================
# Part of OmniForge - Infinite Architectures. Instant Foundation.
#
# Usage: omni [options]
#
# Modes:
#   (no args)          Launch interactive menu (default)
#   --init             Direct bootstrap (skip menu)
#   --settings         Settings manager (copy IDE configs)
#   --run              Run all phases non-interactively
#
# Options:
#   -n, --dry-run      Show what would be done without executing
#   -v, --verbose      Enable verbose output
#   -f, --force        Ignore previous state, re-run all scripts
#   -p, --phase NUM    Run only specified phase
#   -l, --list         List all phases without running
#   -s, --status       Show current status
#   -h, --help         Show this help message
#
# Environment Variables:
#   DRY_RUN=true       Same as --dry-run
#   VERBOSE=true       Same as --verbose
#   ALLOW_DIRTY=true   Skip git clean check
#   GIT_SAFETY=false   Disable git safety checks
#   STACK_PROFILE      Set stack profile (minimal, api-only, full)
#
# Dependencies:
#   lib/common.sh      (loads all library modules)
# =============================================================================

set -Eeuo pipefail
IFS=$'\n\t'

readonly CODENAME="OmniForge"

# Set TERM if not set (prevents tput errors in non-interactive shells)
: "${TERM:=xterm-256color}"
export TERM

# =============================================================================
# PATH SETUP
# =============================================================================

SCRIPT_DIR="$(cd -- "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
OMNI_ROOT="${OMNI_ROOT:-"${SCRIPT_DIR}/.."}"

# Central bootstrap loader (delegates to common.sh)
# shellcheck source=/dev/null
. "${OMNI_ROOT}/lib/bootstrap.sh"

# =============================================================================
# USAGE
# =============================================================================

usage() {
    cat << EOF
${CODENAME} - Infinite Architectures. Instant Foundation.

Usage: omni [mode] [options]

Modes (default: interactive menu):
  (no args)          Launch interactive menu
  --init             Direct bootstrap workflow (skip menu)
  --settings         Settings manager (copy IDE/tool configs)
  --run              Run all phases non-interactively
  --purge            Purge download cache

Options:
  -n, --dry-run      Show what would be done without executing
  -v, --verbose      Enable verbose output
  -q, --quiet        Minimal output (errors only)
  -f, --force        Ignore previous state, re-run all scripts
  -p, --phase NUM    Run only specified phase (e.g., -p 0)
  -l, --list         List all phases without running
  -s, --status       Show current status
  -c, --config       Show configuration summary
  -h, --help         Show this help message

Environment Variables:
  DRY_RUN=true       Same as --dry-run
  VERBOSE=true       Same as --verbose
  ALLOW_DIRTY=true   Skip git clean check
  GIT_SAFETY=false   Disable git safety checks
  STACK_PROFILE      Set stack profile (minimal, api-only, full)
  NON_INTERACTIVE    Skip prompts (for CI/automation)

Examples:
  omni                         # Interactive menu (default)
  omni --init                  # Direct bootstrap workflow
  omni --settings              # Copy IDE configs to project
  omni --run                   # Run all phases (non-interactive)
  omni --run --dry-run         # Preview all actions
  omni --phase 0               # Run only phase 0
  omni --list                  # List all phases
  omni --status                # Show current status
  omni --purge                 # Clear download cache
EOF
}

# =============================================================================
# ARGUMENT PARSING
# =============================================================================

# Execution mode
MODE="menu"  # Default to interactive menu
FORCE=false
SINGLE_PHASE=""
LIST_ONLY=false
SHOW_STATUS=false
SHOW_CONFIG=false
FAIL_FAST=false
QUIET_MODE=false

while [[ $# -gt 0 ]]; do
    case $1 in
        -h|--help)
            usage
            exit 0
            ;;
        # Mode selection
        --init)
            MODE="init"
            shift
            ;;
        --settings)
            MODE="settings"
            shift
            ;;
        --run)
            MODE="run"
            shift
            ;;
        --purge)
            MODE="purge"
            shift
            ;;
        --menu)
            MODE="menu"
            shift
            ;;
        # Options
        -n|--dry-run)
            DRY_RUN=true
            shift
            ;;
        -v|--verbose)
            VERBOSE=true
            LOG_LEVEL="verbose"
            shift
            ;;
        -q|--quiet)
            QUIET_MODE=true
            LOG_LEVEL="quiet"
            shift
            ;;
        -f|--force)
            FORCE=true
            shift
            ;;
        --fail-fast)
            FAIL_FAST=true
            EXECUTION_MODE="fail-fast"
            shift
            ;;
        --continue)
            EXECUTION_MODE="continue"
            shift
            ;;
        -p|--phase)
            MODE="phase"
            SINGLE_PHASE="$2"
            shift 2
            ;;
        -l|--list)
            LIST_ONLY=true
            MODE="list"
            shift
            ;;
        -s|--status)
            SHOW_STATUS=true
            MODE="status"
            shift
            ;;
        -c|--config)
            SHOW_CONFIG=true
            MODE="config"
            shift
            ;;
        *)
            log_error "Unknown option: $1"
            usage
            exit 1
            ;;
    esac
done

# =============================================================================
# MAIN EXECUTION
# =============================================================================

main() {
    local exit_code=0

    # Load configuration first (needed for prereq versions)
    config_load
    config_validate
    config_apply_profile

    # Initialize logging
    log_init "omniforge"

    # Perform log rotation and cleanup (background, non-blocking)
    ensure_log_dir "${LOG_DIR}" || true
    log_rotate_if_needed "${LOG_DIR}" || true
    log_cleanup_if_needed "${LOG_DIR}" || true

    # =========================================================================
    # LOCAL TOOLS SETUP (Self-Contained Environment)
    # =========================================================================
    # Check if local Node.js/pnpm exist, install if missing
    # This ensures project is fully self-contained

    if ! prereqs_local_node_exists || ! prereqs_local_pnpm_exists; then
        log_info "Setting up project-local development tools..."
        echo ""

        if ! prereqs_local_setup_all; then
            log_error "Failed to setup local tools"
            log_info "See error details above"
            exit 1
        fi

        echo ""
    fi

    # Activate local tools environment (prepend .tools/node/bin to PATH)
    if [[ -f "${TOOLS_ACTIVATE_SCRIPT}" ]]; then
        # shellcheck source=/dev/null
        source "${TOOLS_ACTIVATE_SCRIPT}" > /dev/null 2>&1
        log_debug "Local tools activated: Node.js $(node --version 2>/dev/null), pnpm $(pnpm --version 2>/dev/null)"
    fi

    # =========================================================================
    # OMNIFORGE PROJECT SETUP (One-Time Initialization)
    # =========================================================================
    # Deploy template files and prepare project structure
    # This runs once per project (idempotent via marker file)

    if ! setup_omniforge_project; then
        log_error "OmniForge project setup failed"
        log_info "See error details above"
        exit 1
    fi

    # Set tech stack directory
    local tech_stack_dir="${SCRIPTS_DIR}/tech_stack"

    # =========================================================================
    # AUTO-DETECTION (First Run Only)
    # =========================================================================
    # Detect project settings on first run

    if autodetect_is_needed; then
        log_debug "First run detected - running auto-detection"
        autodetect_run_all
        autodetect_write_to_config

        # Reload config to pick up new values
        config_load
    fi

    # =========================================================================
    # MODE DISPATCH
    # =========================================================================

    case "$MODE" in
        menu)
            # Interactive menu (default)
            menu_main
            exit 0
            ;;

        settings)
            # Settings manager
            settings_interactive
            exit 0
            ;;

        purge)
            # Purge download cache
            downloads_purge
            exit 0
            ;;

        list)
            # List phases
            phase_list_all
            exit 0
            ;;

        status)
            # Show status
            state_show_status
            exit 0
            ;;

        config)
            # Show config
            config_show_summary
            exit 0
            ;;

        init)
            # Direct bootstrap workflow (interactive steps)
            menu_bootstrap
            exit 0
            ;;

        run|phase)
            # Non-interactive run (continue below)
            ;;

        *)
            log_error "Unknown mode: $MODE"
            usage
            exit 1
            ;;
    esac

    # =========================================================================
    # NON-INTERACTIVE RUN MODE (--run or --phase)
    # =========================================================================

    # Run enhanced configuration validation
    if ! config_validate_all; then
        log_error "Configuration validation failed"
        config_suggest_fixes
        log_show_file_hint
        exit 1
    fi

    # =========================================================================
    # STEP 1: Start background processes (prereqs + indexer)
    # =========================================================================
    # These run WHILE we show banner and validate config, saving time

    # Start prereq installation if needed
    if ! prereqs_all_met; then
        prereqs_install_background
    fi

    # Start script indexer in background (for requirements validation)
    indexer_start_background "$tech_stack_dir"

    # Banner (shows while background processes run)
    ascii_show_logo
    ascii_show_tagline
    echo ""
    log_info "  App: ${APP_NAME:-bloom2}"
    log_info "  Mode: $([ "${DRY_RUN:-false}" == "true" ] && echo "dry-run" || echo "live")"
    log_info "  Profile: ${STACK_PROFILE:-full}"
    log_info "  Resume: ${BOOTSTRAP_RESUME_MODE:-skip}"
    echo ""

    # Initialize execution statistics
    phase_stats_init

    # =========================================================================
    # STEP 2: Run preflight checks (validates config while prereqs install)
    # =========================================================================
    if ! phase_preflight_check "$tech_stack_dir"; then
        log_error "Preflight check failed. Please fix the issues above."
        exit 1
    fi
    echo ""

    # =========================================================================
    # STEP 3: Wait for background processes to complete
    # =========================================================================

    # Wait for prereq installation
    if prereqs_is_running; then
        log_info "Waiting for prerequisite installation to complete..."
        if ! prereqs_wait; then
            log_error "Prerequisite installation failed."
            prereqs_show_progress
            exit 1
        fi
    fi

    # Verify prerequisites are actually installed
    if ! prereqs_verify; then
        log_error "Prerequisites not met. Please install manually."
        exit 1
    fi

    # Wait for indexer and validate requirements
    if indexer_is_running; then
        indexer_wait
    fi

    # Check if all required variables are set
    if ! indexer_validate_requirements; then
        log_warn "Some required variables are not set in bootstrap.conf"
        # Offer to inject missing variables
        if [[ "${NON_INTERACTIVE:-false}" != "true" ]]; then
            echo ""
            read -rp "Would you like to add missing variables to bootstrap.conf? [y/N] " inject_choice
            if [[ "${inject_choice,,}" == "y" ]]; then
                indexer_inject_missing_vars "${BOOTSTRAP_CONF}"
                log_warn "Please update the added variables and run omni again"
                exit 1
            fi
        fi
    fi
    echo ""

    # Git safety check
    git_ensure_clean

    # Single phase or all phases
    if [[ "$MODE" == "phase" && -n "$SINGLE_PHASE" ]]; then
        log_info "Running single phase: $SINGLE_PHASE"
        if phase_execute "$SINGLE_PHASE" "$tech_stack_dir" "$FORCE"; then
            phase_stats_record "$SINGLE_PHASE" "completed"
        else
            phase_stats_record "$SINGLE_PHASE" "failed"
            exit_code=1
        fi
    else
        log_info "Running all phases..."
        if phase_execute_all "$tech_stack_dir" "$FORCE"; then
            # Count completed phases for stats
            local phases
            local OLD_IFS="$IFS"
            IFS=' '
            read -ra phases <<< "$(phase_discover)"
            IFS="$OLD_IFS"
            for p in "${phases[@]}"; do
                if phase_is_enabled "$p"; then
                    phase_stats_record "$p" "completed"
                else
                    phase_stats_record "$p" "skipped"
                fi
            done
        else
            exit_code=1
            phase_stats_record "unknown" "failed"
        fi
    fi

    # Show execution recap and next steps
    phase_show_recap

    exit $exit_code
}

main "$@"
