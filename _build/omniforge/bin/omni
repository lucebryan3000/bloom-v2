#!/usr/bin/env bash
# =============================================================================
# bin/omni - OmniForge Main Entry Point
# =============================================================================
# Part of OmniForge - The Factory That Builds Universes
#
# Usage: omni [options]
#
# Options:
#   -n, --dry-run      Show what would be done without executing
#   -v, --verbose      Enable verbose output
#   -f, --force        Ignore previous state, re-run all scripts
#   -p, --phase NUM    Run only specified phase
#   -l, --list         List all phases without running
#   -s, --status       Show current status
#   -h, --help         Show this help message
#
# Environment Variables:
#   DRY_RUN=true       Same as --dry-run
#   VERBOSE=true       Same as --verbose
#   ALLOW_DIRTY=true   Skip git clean check
#   GIT_SAFETY=false   Disable git safety checks
#   STACK_PROFILE      Set stack profile (minimal, api-only, full)
#
# Dependencies:
#   lib/common.sh      (loads all library modules)
# =============================================================================

set -euo pipefail

readonly CODENAME="OmniForge"

# =============================================================================
# PATH SETUP
# =============================================================================

# Determine script location
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
SCRIPTS_DIR="$(cd "$SCRIPT_DIR/.." && pwd)"

# Source the common library (loads all modules)
source "${SCRIPTS_DIR}/lib/common.sh"

# =============================================================================
# USAGE
# =============================================================================

usage() {
    cat << EOF
${CODENAME} - The Factory That Builds Universes

Usage: omni [options]

Initialize the project by running all phase scripts in sequence.

Options:
  -n, --dry-run      Show what would be done without executing
  -v, --verbose      Enable verbose output
  -f, --force        Ignore previous state, re-run all scripts
  -p, --phase NUM    Run only specified phase (e.g., -p 0)
  -l, --list         List all phases without running
  -s, --status       Show current status
  -h, --help         Show this help message

Environment Variables:
  DRY_RUN=true       Same as --dry-run
  VERBOSE=true       Same as --verbose
  ALLOW_DIRTY=true   Skip git clean check
  GIT_SAFETY=false   Disable git safety checks
  STACK_PROFILE      Set stack profile (minimal, api-only, full)

Examples:
  omni                         # Run all phases
  omni --dry-run               # Preview all actions
  omni --phase 0               # Run only phase 0
  omni --list                  # List all phases
  omni --status                # Show current status
EOF
}

# =============================================================================
# ARGUMENT PARSING
# =============================================================================

FORCE=false
SINGLE_PHASE=""
LIST_ONLY=false
SHOW_STATUS=false

while [[ $# -gt 0 ]]; do
    case $1 in
        -h|--help)
            usage
            exit 0
            ;;
        -n|--dry-run)
            DRY_RUN=true
            shift
            ;;
        -v|--verbose)
            VERBOSE=true
            shift
            ;;
        -f|--force)
            FORCE=true
            shift
            ;;
        -p|--phase)
            SINGLE_PHASE="$2"
            shift 2
            ;;
        -l|--list)
            LIST_ONLY=true
            shift
            ;;
        -s|--status)
            SHOW_STATUS=true
            shift
            ;;
        *)
            log_error "Unknown option: $1"
            usage
            exit 1
            ;;
    esac
done

# =============================================================================
# MAIN EXECUTION
# =============================================================================

main() {
    local exit_code=0

    # Load configuration first (needed for prereq versions)
    config_load
    config_validate
    config_apply_profile

    # Initialize logging
    log_init "omniforge"

    # Set tech stack directory
    local tech_stack_dir="${SCRIPTS_DIR}/tech_stack"

    # Handle special modes (don't need prereqs)
    if [[ "$LIST_ONLY" == "true" ]]; then
        phase_list_all
        exit 0
    fi

    if [[ "$SHOW_STATUS" == "true" ]]; then
        state_show_status
        exit 0
    fi

    # =========================================================================
    # STEP 1: Start prereq installation in background (if needed)
    # =========================================================================
    # This runs WHILE we show banner and validate config, saving time
    if ! prereqs_all_met; then
        prereqs_install_background
    fi

    # Banner (shows while prereqs install in background)
    log_info "=========================================="
    log_info "  OMNIFORGE - The Factory That Builds Universes"
    log_info "=========================================="
    log_info "  App: ${APP_NAME:-bloom2}"
    log_info "  Mode: ${DRY_RUN:-false} && dry-run || live"
    log_info "  Profile: ${STACK_PROFILE:-full}"
    log_info "  Resume: ${BOOTSTRAP_RESUME_MODE:-skip}"
    log_info "=========================================="
    echo ""

    # Initialize execution statistics
    phase_stats_init

    # =========================================================================
    # STEP 2: Run preflight checks (validates config while prereqs install)
    # =========================================================================
    if ! phase_preflight_check "$tech_stack_dir"; then
        log_error "Preflight check failed. Please fix the issues above."
        exit 1
    fi
    echo ""

    # =========================================================================
    # STEP 3: Wait for background prereq installation to complete
    # =========================================================================
    if prereqs_is_running; then
        log_info "Waiting for prerequisite installation to complete..."
        if ! prereqs_wait; then
            log_error "Prerequisite installation failed."
            prereqs_show_progress
            exit 1
        fi
    fi

    # Verify prerequisites are actually installed
    if ! prereqs_verify; then
        log_error "Prerequisites not met. Please install manually."
        exit 1
    fi
    echo ""

    # Git safety check
    git_ensure_clean

    # Single phase or all phases
    if [[ -n "$SINGLE_PHASE" ]]; then
        log_info "Running single phase: $SINGLE_PHASE"
        if phase_execute "$SINGLE_PHASE" "$tech_stack_dir" "$FORCE"; then
            phase_stats_record "$SINGLE_PHASE" "completed"
        else
            phase_stats_record "$SINGLE_PHASE" "failed"
            exit_code=1
        fi
    else
        log_info "Running all phases..."
        if phase_execute_all "$tech_stack_dir" "$FORCE"; then
            # Count completed phases for stats
            local phases
            local OLD_IFS="$IFS"
            IFS=' '
            read -ra phases <<< "$(phase_discover)"
            IFS="$OLD_IFS"
            for p in "${phases[@]}"; do
                if phase_is_enabled "$p"; then
                    phase_stats_record "$p" "completed"
                else
                    phase_stats_record "$p" "skipped"
                fi
            done
        else
            exit_code=1
            phase_stats_record "unknown" "failed"
        fi
    fi

    # Show execution recap and next steps
    phase_show_recap

    exit $exit_code
}

main "$@"
