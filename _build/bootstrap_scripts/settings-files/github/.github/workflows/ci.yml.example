# ==============================================================================
# ci.yml - GitHub Actions CI Pipeline Template
# ==============================================================================
#
# LOCATION: /.github/workflows/ci.yml (project root)
#
# PURPOSE:
#   Run continuous integration checks on every push and pull request.
#   Includes linting, type checking, building, and testing for both
#   Node.js (Next.js) and Python backends.
#
# USAGE:
#   1. Create .github/workflows/ directory in your project root
#   2. Copy this file to .github/workflows/ci.yml
#   3. Customize jobs based on your tech stack (remove Python if not needed)
#   4. Configure branch protection to require CI passing
#
# BOOTSTRAP INTEGRATION:
#   Bootstrap scripts can customize based on bootstrap.conf:
#   - ENABLE_PYTHON -> Include/exclude Python jobs
#   - NODE_VERSION, PYTHON_VERSION -> Version specifications
#   After setup, this file is the authoritative source for CI configuration.
#
# ==============================================================================

name: CI Pipeline

# ==============================================================================
# TRIGGERS
# ==============================================================================
on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

# Cancel in-progress runs when a new commit is pushed
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

# ==============================================================================
# JOBS
# ==============================================================================
jobs:
  # ============================================================================
  # NODE.JS BUILD & TEST
  # ============================================================================
  build-node:
    name: Node.js - Build & Test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      # Setup pnpm first (required for caching)
      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 9

      # Setup Node.js with caching
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
          cache: 'pnpm'

      # Install dependencies
      - name: Install Dependencies
        run: pnpm install --frozen-lockfile

      # Linting
      - name: Run ESLint
        run: pnpm lint

      # Type checking
      - name: TypeScript Check
        run: pnpm typecheck

      # Build
      - name: Build Application
        run: pnpm build

      # Unit tests
      - name: Run Tests
        run: pnpm test

      # Upload coverage (optional)
      # - name: Upload Coverage
      #   uses: actions/upload-artifact@v4
      #   with:
      #     name: coverage-report
      #     path: coverage/

  # ============================================================================
  # PYTHON BUILD & TEST (Optional - remove if not using Python)
  # ============================================================================
  build-python:
    name: Python - Build & Test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      # Setup Python with caching
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version-file: '.python-version'
          cache: 'pip'

      # Install dependencies
      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
        # For Poetry: pip install poetry && poetry install --no-root

      # Linting (optional)
      # - name: Run Ruff/Flake8
      #   run: ruff check src/

      # Type checking
      - name: Run Mypy
        run: mypy src/
        continue-on-error: true  # Remove after fixing type errors

      # Tests
      - name: Run Pytest
        run: pytest tests/ -v --tb=short

  # ============================================================================
  # E2E TESTS (Optional - runs after build jobs pass)
  # ============================================================================
  # e2e-tests:
  #   name: E2E Tests
  #   runs-on: ubuntu-latest
  #   needs: [build-node]
  #
  #   steps:
  #     - name: Checkout Repository
  #       uses: actions/checkout@v4
  #
  #     - name: Setup pnpm
  #       uses: pnpm/action-setup@v2
  #       with:
  #         version: 9
  #
  #     - name: Setup Node.js
  #       uses: actions/setup-node@v4
  #       with:
  #         node-version-file: '.nvmrc'
  #         cache: 'pnpm'
  #
  #     - name: Install Dependencies
  #       run: pnpm install --frozen-lockfile
  #
  #     - name: Install Playwright Browsers
  #       run: pnpm exec playwright install --with-deps
  #
  #     - name: Run E2E Tests
  #       run: pnpm test:e2e
  #
  #     - name: Upload Playwright Report
  #       if: failure()
  #       uses: actions/upload-artifact@v4
  #       with:
  #         name: playwright-report
  #         path: playwright-report/

# ==============================================================================
# END OF CI WORKFLOW
# ==============================================================================
