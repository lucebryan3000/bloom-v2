#!/usr/bin/env bash
# =============================================================================
# breakpoints.conf - LLM handoff points and manual intervention definitions
# =============================================================================
# Format: PHASE_ID:BREAKPOINT_TYPE:TITLE:INSTRUCTIONS
#
# Breakpoint Types:
#   llm      - Requires LLM customization/generation
#   human    - Requires human input (credentials, config)
#   verify   - Verification checkpoint (run tests, check output)
#   optional - Can be skipped with --skip-breakpoints
# =============================================================================

# Breakpoint definitions
BREAKPOINTS=(
    # After database setup - need connection + schema customization
    "db:human:Database Configuration:
REQUIRED HUMAN ACTIONS:
  1. Start PostgreSQL: docker compose up -d
  2. Copy .env.example to .env
  3. Update DATABASE_URL in .env with your credentials
  4. Run: pnpm db:push

VERIFICATION:
  - Run: pnpm db:studio (should open Drizzle Studio)
  - Check: Tables created in database

LLM HANDOFF:
  - Review src/db/schema.ts
  - Add domain-specific tables (e.g., users, sessions, your business entities)
  - Create relationships between tables
  - Add indexes for common queries
"

    # After auth setup - need OAuth credentials
    "auth:human:Authentication Setup:
REQUIRED HUMAN ACTIONS:
  1. Generate NEXTAUTH_SECRET: openssl rand -base64 32
  2. Add to .env: NEXTAUTH_SECRET=<generated-value>
  3. For OAuth providers, obtain credentials:
     - Google: https://console.cloud.google.com/apis/credentials
     - GitHub: https://github.com/settings/developers
  4. Add provider credentials to .env

VERIFICATION:
  - Run: pnpm dev
  - Navigate to /login
  - Check: Login page renders without errors

LLM HANDOFF:
  - Edit src/lib/auth/config.ts to add providers
  - Configure session/JWT callbacks for your use case
  - Add role-based access control if needed
  - Create protected route patterns in middleware.ts
"

    # After AI setup - need API key + prompt customization
    "ai:llm:AI Integration Customization:
REQUIRED HUMAN ACTIONS:
  1. Get Anthropic API key: https://console.anthropic.com/
  2. Add to .env: ANTHROPIC_API_KEY=<your-key>

VERIFICATION:
  - Run: pnpm dev
  - Test: POST to /api/chat with {\"messages\": [{\"role\": \"user\", \"content\": \"Hello\"}]}
  - Check: Streaming response works

LLM HANDOFF (CRITICAL):
  - Edit src/lib/ai/prompts/system.ts with your AI persona
  - For Bloom2/Melissa.ai, create:
    * Melissa system prompt with personality
    * Phase-specific prompts (assessment, planning, coaching)
    * Tool-use definitions if using function calling
  - Create structured output schemas in src/lib/ai/schemas/
  - Add conversation memory/history management
  - Implement token counting and context window management
"

    # After UI setup - component customization
    "ui:llm:UI Component Customization:
NO HUMAN ACTIONS REQUIRED

LLM HANDOFF:
  - Customize shadcn/ui theme in src/app/globals.css
  - Create app-specific components:
    * Navigation/sidebar layout
    * Dashboard widgets
    * Data tables with sorting/filtering
    * Form components with validation
  - For Bloom2:
    * Student dashboard view
    * Assessment result displays
    * Progress tracking charts
    * Learning path visualizations
  - Add dark mode toggle if needed
  - Create loading skeletons for async content
"

    # Final verification checkpoint
    "quality:verify:Final Verification:
VERIFICATION CHECKLIST:
  □ pnpm install      (no errors)
  □ pnpm lint         (no errors or warnings)
  □ pnpm typecheck    (if added to scripts)
  □ pnpm test         (all tests pass)
  □ pnpm build        (production build succeeds)
  □ pnpm dev          (app starts on localhost:3000)

SMOKE TESTS:
  □ Home page loads
  □ Login page accessible
  □ API routes respond (health check)
  □ Database queries work
  □ Styles render correctly

IF ALL PASS:
  Your bootstrap is complete!

NEXT: Begin implementing domain-specific features.
  For Bloom2/Melissa.ai:
  - Student onboarding flow
  - Assessment engine
  - AI coaching conversations
  - Progress tracking
  - Parent/teacher dashboards
"
)

# =============================================================================
# Breakpoint helper functions
# =============================================================================

# Get breakpoint for a phase (if any)
get_breakpoint() {
    local phase_id="$1"
    for bp in "${BREAKPOINTS[@]}"; do
        if [[ "${bp%%:*}" == "${phase_id}" ]]; then
            echo "${bp}"
            return 0
        fi
    done
    return 1
}

# Get breakpoint type
get_breakpoint_type() {
    local bp="$1"
    echo "${bp}" | cut -d: -f2
}

# Get breakpoint title
get_breakpoint_title() {
    local bp="$1"
    echo "${bp}" | cut -d: -f3
}

# Get breakpoint instructions
get_breakpoint_instructions() {
    local bp="$1"
    echo "${bp}" | cut -d: -f4-
}

# Check if breakpoint should pause execution
should_pause_at_breakpoint() {
    local phase_id="$1"
    local skip_breakpoints="${SKIP_BREAKPOINTS:-false}"

    [[ "${skip_breakpoints}" == "true" ]] && return 1

    local bp
    bp=$(get_breakpoint "${phase_id}") || return 1

    local bp_type
    bp_type=$(get_breakpoint_type "${bp}")

    # Optional breakpoints can be skipped
    [[ "${bp_type}" == "optional" ]] && return 1

    return 0
}

# Export breakpoint to markdown file for LLM handoff
export_breakpoint_doc() {
    local phase_id="$1"
    local output_dir="${2:-scripts/bootstrap/state/handoffs}"

    local bp
    bp=$(get_breakpoint "${phase_id}") || return 1

    mkdir -p "${output_dir}"

    local title instructions timestamp
    title=$(get_breakpoint_title "${bp}")
    instructions=$(get_breakpoint_instructions "${bp}")
    timestamp=$(date +"%Y-%m-%d %H:%M:%S")

    local output_file="${output_dir}/${phase_id}-handoff.md"

    cat > "${output_file}" << EOF
# LLM Handoff: ${title}

**Phase:** ${phase_id}
**Generated:** ${timestamp}
**Status:** Awaiting action

---

${instructions}

---

## Files to Review

$(find_phase_output_files "${phase_id}")

## Resume Command

After completing the above tasks, resume bootstrap with:

\`\`\`bash
./run-bootstrap.sh --resume
\`\`\`

Or to continue from this specific phase:

\`\`\`bash
./run-bootstrap.sh --from ${phase_id}
\`\`\`
EOF

    echo "${output_file}"
}

# Find files created by a phase (for LLM context)
find_phase_output_files() {
    local phase_id="$1"

    case "${phase_id}" in
        db)
            echo "- src/db/schema.ts"
            echo "- src/db/index.ts"
            echo "- drizzle.config.ts"
            ;;
        auth)
            echo "- src/lib/auth/config.ts"
            echo "- src/middleware.ts"
            echo "- src/app/api/auth/[...nextauth]/route.ts"
            echo "- src/app/(auth)/login/page.tsx"
            ;;
        ai)
            echo "- src/lib/ai/client.ts"
            echo "- src/lib/ai/config.ts"
            echo "- src/lib/ai/prompts/system.ts"
            echo "- src/lib/ai/prompts/builder.ts"
            echo "- src/app/api/chat/route.ts"
            echo "- src/components/chat/Chat.tsx"
            ;;
        ui)
            echo "- src/components/ui/button.tsx"
            echo "- src/lib/utils.ts"
            echo "- components.json"
            echo "- src/app/globals.css"
            ;;
        quality)
            echo "- tsconfig.json"
            echo "- .eslintrc.json"
            echo "- .prettierrc"
            echo "- .husky/pre-commit"
            ;;
        *)
            echo "(No specific files listed for this phase)"
            ;;
    esac
}
